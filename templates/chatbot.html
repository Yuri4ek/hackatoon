{% extends "base.html" %}

{% block title %}–ß–∞—Ç-–±–æ—Ç - NutriPlan{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 sidebar p-3">
            <h5 class="mb-3">–ù–∞–≤–∏–≥–∞—Ü–∏—è</h5>
            <nav class="nav flex-column">
                <a class="nav-link" href="{{ url_for('dashboard') }}">
                    <i class="fas fa-tachometer-alt"></i> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                </a>
                <a class="nav-link" href="{{ url_for('profile') }}">
                    <i class="fas fa-user"></i> –ü—Ä–æ—Ñ–∏–ª—å
                </a>
                <a class="nav-link" href="{{ url_for('meal_planner') }}">
                    <i class="fas fa-calendar-alt"></i> –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–∏—Ç–∞–Ω–∏—è
                </a>
                <a class="nav-link" href="{{ url_for('nutrition_analysis') }}">
                    <i class="fas fa-chart-pie"></i> –ê–Ω–∞–ª–∏–∑ —Ä–∞—Ü–∏–æ–Ω–∞
                </a>
                <a class="nav-link" href="{{ url_for('chat') }}">
                    <i class="fas fa-comments"></i> –ß–∞—Ç —Å –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º
                </a>
                <a class="nav-link active" href="{{ url_for('chatbot') }}">
                    <i class="fas fa-robot"></i> –ß–∞—Ç-–±–æ—Ç
                </a>
            </nav>
        </div>
        
        <div class="col-md-9 p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-robot text-primary"></i> –ß–∞—Ç-–±–æ—Ç NutriPlan</h2>
                <button class="btn btn-outline-secondary btn-sm" onclick="clearChat()">
                    <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
                </button>
            </div>
            
            <div class="row">
                <div class="col-lg-8">
                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —á–∞—Ç-–±–æ—Ç–∞ -->
                    <div class="card shadow-sm chatbot-card">
                        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç-–±–æ—Ç–∞ -->
                        <div class="card-header bg-gradient-primary text-white">
                            <div class="d-flex align-items-center">
                                <div class="bot-avatar me-3">
                                    <i class="fas fa-robot fa-2x"></i>
                                </div>
                                <div class="bot-info">
                                    <h5 class="mb-0">NutriBot</h5>
                                    <div class="small">
                                        <span class="text-light">
                                            <i class="fas fa-circle me-1 pulse" style="font-size: 8px;"></i>
                                            –ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –ø–∏—Ç–∞–Ω–∏–µ–º
                                        </span>
                                    </div>
                                </div>
                                <div class="ms-auto">
                                    <span class="badge bg-light text-primary">AI Assistant</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –¢–µ–ª–æ —á–∞—Ç–∞ -->
                        <div class="card-body p-0">
                            <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
                            <div class="chat-messages p-4" id="chatMessages" style="height: 500px; overflow-y: auto;">
                                <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
                                <div class="message bot-message">
                                    <div class="message-avatar">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="message-content">
                                        <div class="message-text">
                                            –ü—Ä–∏–≤–µ—Ç, {{ current_user.name if current_user.name else '–¥—Ä—É–≥' }}! üëã 
                                            –Ø NutriBot - –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–∏—Ç–∞–Ω–∏—é!
                                            <br><br>
                                            –Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Å:
                                            <ul class="mb-0 mt-2">
                                                <li>üçé –†–∞—Å—á–µ—Ç–æ–º –∫–∞–ª–æ—Ä–∏–π –∏ –ë–ñ–£</li>
                                                <li>üìä –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–∏—Ç–∞–Ω–∏—è</li>
                                                <li>üí° –°–æ–≤–µ—Ç–∞–º–∏ –ø–æ –∑–¥–æ—Ä–æ–≤–æ–º—É –æ–±—Ä–∞–∑—É –∂–∏–∑–Ω–∏</li>
                                                <li>ü•ó –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</li>
                                            </ul>
                                            <br>
                                            –ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–∏—Ç–∞–Ω–∏–∏!
                                        </div>
                                        <div class="message-time">
                                            {{ moment().format('HH:mm') if moment else '—Å–µ–π—á–∞—Å' }}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π -->
                                {% for msg in recent_messages %}
                                <div class="message user-message">
                                    <div class="message-content">
                                        <div class="message-text">{{ msg.message }}</div>
                                        <div class="message-time">{{ msg.created_at.strftime('%H:%M') }}</div>
                                    </div>
                                    <div class="message-avatar">
                                        <i class="fas fa-user"></i>
                                    </div>
                                </div>
                                
                                <div class="message bot-message">
                                    <div class="message-avatar">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <div class="message-content">
                                        <div class="message-text">{{ msg.response }}</div>
                                        <div class="message-time">{{ msg.created_at.strftime('%H:%M') }}</div>
                                    </div>
                                </div>
                                {% endfor %}
                                
                                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ -->
                                <div class="typing-indicator d-none" id="typingIndicator">
                                    <div class="message bot-message">
                                        <div class="message-avatar">
                                            <i class="fas fa-robot"></i>
                                        </div>
                                        <div class="message-content">
                                            <div class="typing-dots">
                                                <span class="dot"></span>
                                                <span class="dot"></span>
                                                <span class="dot"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                            <div class="chat-input-area p-3 border-top bg-light">
                                <form id="chatForm">
                                    <div class="input-group">
                                        <input type="text" 
                                               class="form-control form-control-lg" 
                                               id="messageInput" 
                                               placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –æ –ø–∏—Ç–∞–Ω–∏–∏, –∫–∞–ª–æ—Ä–∏—è—Ö, –ë–ñ–£..." 
                                               autocomplete="off">
                                        <button class="btn btn-primary btn-lg" type="submit" id="sendButton">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>–û NutriBot</h6>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <div class="bot-avatar-large mx-auto mb-3">
                                    <i class="fas fa-robot fa-3x text-primary"></i>
                                </div>
                                <h6>–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç</h6>
                                <p class="text-muted small">–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –≤–æ–ø—Ä–æ—Å–∞—Ö –ø–∏—Ç–∞–Ω–∏—è –∏ –∑–¥–æ—Ä–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞ –∂–∏–∑–Ω–∏</p>
                            </div>
                            
                            <div class="bot-stats">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="stat-item">
                                            <div class="stat-number">24/7</div>
                                            <div class="stat-label">–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-item">
                                            <div class="stat-number">‚àû</div>
                                            <div class="stat-label">–¢–µ—Ä–ø–µ–Ω–∏–µ</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-lightning-bolt me-2"></i>–ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h6>
                        </div>
                        <div class="card-body">
                            <div class="quick-questions">
                                <button class="btn btn-outline-primary btn-sm mb-2 w-100 text-start" onclick="sendQuickQuestion('–°–∫–æ–ª—å–∫–æ –∫–∞–ª–æ—Ä–∏–π –º–Ω–µ –Ω—É–∂–Ω–æ –≤ –¥–µ–Ω—å?')">
                                    <i class="fas fa-fire me-2"></i>–°–∫–æ–ª—å–∫–æ –∫–∞–ª–æ—Ä–∏–π –º–Ω–µ –Ω—É–∂–Ω–æ?
                                </button>
                                <button class="btn btn-outline-success btn-sm mb-2 w-100 text-start" onclick="sendQuickQuestion('–ö–∞–∫–æ–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ë–ñ–£?')">
                                    <i class="fas fa-chart-pie me-2"></i>–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –ë–ñ–£?
                                </button>
                                <button class="btn btn-outline-info btn-sm mb-2 w-100 text-start" onclick="sendQuickQuestion('–°–∫–æ–ª—å–∫–æ –≤–æ–¥—ã –Ω—É–∂–Ω–æ –ø–∏—Ç—å?')">
                                    <i class="fas fa-tint me-2"></i>–°–∫–æ–ª—å–∫–æ –ø–∏—Ç—å –≤–æ–¥—ã?
                                </button>
                                <button class="btn btn-outline-warning btn-sm mb-2 w-100 text-start" onclick="sendQuickQuestion('–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ—Ö—É–¥–µ—Ç—å?')">
                                    <i class="fas fa-weight me-2"></i>–ö–∞–∫ –ø–æ—Ö—É–¥–µ—Ç—å?
                                </button>
                                <button class="btn btn-outline-secondary btn-sm mb-2 w-100 text-start" onclick="sendQuickQuestion('–ß—Ç–æ –µ—Å—Ç—å –¥–ª—è –Ω–∞–±–æ—Ä–∞ –º–∞—Å—Å—ã?')">
                                    <i class="fas fa-dumbbell me-2"></i>–ù–∞–±–æ—Ä –º–∞—Å—Å—ã?
                                </button>
                                <button class="btn btn-outline-dark btn-sm w-100 text-start" onclick="sendQuickQuestion('–ö–∞–∫–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Å–∞–º—ã–µ –ø–æ–ª–µ–∑–Ω—ã–µ?')">
                                    <i class="fas fa-apple-alt me-2"></i>–ü–æ–ª–µ–∑–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã?
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è —á–∞—Ç-–±–æ—Ç–∞ */
.chatbot-card {
    border: none;
    border-radius: 15px;
    overflow: hidden;
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #28a745, #20c997);
}

.bot-avatar {
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.bot-avatar-large {
    width: 80px;
    height: 80px;
    background: rgba(40, 167, 69, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.chat-messages {
    display: flex;
    flex-direction: column;
    gap: 20px;
    background: #f8f9fa;
}

.message {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    max-width: 85%;
}

.user-message {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.bot-message {
    align-self: flex-start;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    color: white;
    font-size: 16px;
}

.user-message .message-avatar {
    background: linear-gradient(135deg, #007bff, #0056b3);
}

.bot-message .message-avatar {
    background: linear-gradient(135deg, #28a745, #20c997);
}

.message-content {
    flex: 1;
}

.message-text {
    background: white;
    padding: 12px 16px;
    border-radius: 18px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    word-wrap: break-word;
    line-height: 1.5;
}

.user-message .message-text {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border-bottom-right-radius: 6px;
}

.bot-message .message-text {
    background: white;
    color: #333;
    border-bottom-left-radius: 6px;
    border: 1px solid #e9ecef;
}

.message-time {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 4px;
    text-align: right;
}

.user-message .message-time {
    text-align: left;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏ */
.typing-dots {
    display: flex;
    gap: 4px;
    padding: 12px 16px;
    background: white;
    border-radius: 18px;
    border-bottom-left-radius: 6px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.dot {
    width: 8px;
    height: 8px;
    background-color: #28a745;
    border-radius: 50%;
    animation: typing-animation 1.4s infinite ease-in-out both;
}

.dot:nth-child(1) { animation-delay: -0.32s; }
.dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing-animation {
    0%, 80%, 100% { 
        transform: scale(0);
        opacity: 0.5;
    } 
    40% { 
        transform: scale(1);
        opacity: 1;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ */
.quick-questions .btn {
    text-align: left;
    white-space: normal;
    transition: all 0.2s;
    border-radius: 8px;
}

.quick-questions .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞ */
.bot-stats {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
}

.stat-item {
    text-align: center;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: bold;
    color: #28a745;
}

.stat-label {
    font-size: 0.8rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .message {
        max-width: 95%;
    }
    
    .chat-messages {
        padding: 15px;
    }
    
    .message-text {
        padding: 10px 12px;
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π */
.message {
    animation: messageSlideIn 0.3s ease-out;
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö */
.message-text ul {
    margin: 8px 0;
    padding-left: 20px;
}

.message-text li {
    margin: 4px 0;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
    scrollToBottom();
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
            sendMessage(message);
            messageInput.value = '';
        }
    });
    
    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    function sendMessage(message) {
        // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
        sendButton.disabled = true;
        messageInput.disabled = true;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        addUserMessage(message);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        showTypingIndicator();
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch('/api/chatbot', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
            hideTypingIndicator();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
            addBotMessage(data.response);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            hideTypingIndicator();
            addBotMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        })
        .finally(() => {
            // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
            sendButton.disabled = false;
            messageInput.disabled = false;
            messageInput.focus();
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function addUserMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.className = 'message user-message';
        messageElement.innerHTML = `
            <div class="message-content">
                <div class="message-text">${escapeHtml(message)}</div>
                <div class="message-time">${getCurrentTime()}</div>
            </div>
            <div class="message-avatar">
                <i class="fas fa-user"></i>
            </div>
        `;
        
        chatMessages.appendChild(messageElement);
        scrollToBottom();
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞
    function addBotMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.className = 'message bot-message';
        messageElement.innerHTML = `
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
                <div class="message-text">${formatBotMessage(message)}</div>
                <div class="message-time">${getCurrentTime()}</div>
            </div>
        `;
        
        chatMessages.appendChild(messageElement);
        scrollToBottom();
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏
    function showTypingIndicator() {
        typingIndicator.classList.remove('d-none');
        scrollToBottom();
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏
    function hideTypingIndicator() {
        typingIndicator.classList.add('d-none');
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
    function scrollToBottom() {
        setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 100);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    function getCurrentTime() {
        const now = new Date();
        return now.toLocaleTimeString('ru-RU', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞
    function formatBotMessage(message) {
        // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –Ω–∞ <br>
        message = message.replace(/\n/g, '<br>');
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —ç–º–æ–¥–∑–∏ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        message = message.replace(/‚úÖ/g, '<span class="text-success">‚úÖ</span>');
        message = message.replace(/‚ùå/g, '<span class="text-danger">‚ùå</span>');
        message = message.replace(/‚ö†Ô∏è/g, '<span class="text-warning">‚ö†Ô∏è</span>');
        message = message.replace(/üí°/g, '<span class="text-info">üí°</span>');
        message = message.replace(/üéØ/g, '<span class="text-primary">üéØ</span>');
        
        return message;
    }
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
function sendQuickQuestion(question) {
    document.getElementById('messageInput').value = question;
    document.getElementById('chatForm').dispatchEvent(new Event('submit'));
}

// –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —á–∞—Ç–∞
function clearChat() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?')) {
        const chatMessages = document.getElementById('chatMessages');
        const messages = chatMessages.querySelectorAll('.message:not(.bot-message:first-child)');
        
        messages.forEach(message => {
            message.style.animation = 'messageSlideOut 0.3s ease-in';
            setTimeout(() => {
                message.remove();
            }, 300);
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        setTimeout(() => {
            addBotMessage('–ß–∞—Ç –æ—á–∏—â–µ–Ω! –ö–∞–∫ –¥–µ–ª–∞ —Å –ø–∏—Ç–∞–Ω–∏–µ–º? –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å? üòä');
        }, 500);
    }
}

// –ê–Ω–∏–º–∞—Ü–∏—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
const style = document.createElement('style');
style.textContent = `
    @keyframes messageSlideOut {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(-100%);
        }
    }
`;
document.head.appendChild(style);

// –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ (–¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ clearChat)
function addBotMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    const messageElement = document.createElement('div');
    messageElement.className = 'message bot-message';
    messageElement.innerHTML = `
        <div class="message-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
            <div class="message-text">${formatBotMessage(message)}</div>
            <div class="message-time">${getCurrentTime()}</div>
        </div>
    `;
    
    chatMessages.appendChild(messageElement);
    
    setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 100);
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è clearChat
function formatBotMessage(message) {
    message = message.replace(/\n/g, '<br>');
    message = message.replace(/‚úÖ/g, '<span class="text-success">‚úÖ</span>');
    message = message.replace(/‚ùå/g, '<span class="text-danger">‚ùå</span>');
    message = message.replace(/‚ö†Ô∏è/g, '<span class="text-warning">‚ö†Ô∏è</span>');
    message = message.replace(/üí°/g, '<span class="text-info">üí°</span>');
    message = message.replace(/üéØ/g, '<span class="text-primary">üéØ</span>');
    return message;
}

function getCurrentTime() {
    const now = new Date();
    return now.toLocaleTimeString('ru-RU', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
}
</script>
{% endblock %}
